name: Update Cask

on:
  # Check for new releases daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'
  # Manual trigger for immediate update after release
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    name: Check and Update Cask
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest release from VPNBypass
        id: release
        run: |
          # Fetch latest release info
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/GeiserX/VPNBypass/releases/latest")
          
          # Extract version (remove 'v' prefix)
          LATEST_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name' | sed 's/^v//')
          
          if [ "$LATEST_VERSION" == "null" ] || [ -z "$LATEST_VERSION" ]; then
            echo "âŒ Could not fetch latest release"
            exit 1
          fi
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Latest release: v$LATEST_VERSION"
          
          # Get DMG download URL
          DMG_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | endswith(".dmg")) | .browser_download_url')
          echo "dmg_url=$DMG_URL" >> $GITHUB_OUTPUT

      - name: Get current cask version
        id: current
        run: |
          CURRENT_VERSION=$(grep 'version "' Casks/vpn-bypass.rb | sed 's/.*version "\([^"]*\)".*/\1/')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Current cask version: $CURRENT_VERSION"

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.release.outputs.latest_version }}" == "${{ steps.current.outputs.current_version }}" ]; then
            echo "âœ… Cask is up to date (v${{ steps.current.outputs.current_version }})"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”„ Update needed: ${{ steps.current.outputs.current_version }} â†’ ${{ steps.release.outputs.latest_version }}"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Download DMG and calculate SHA256
        if: steps.check.outputs.needs_update == 'true'
        id: sha
        run: |
          echo "â¬‡ï¸ Downloading DMG..."
          curl -L -o vpnbypass.dmg "${{ steps.release.outputs.dmg_url }}"
          
          SHA256=$(shasum -a 256 vpnbypass.dmg | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "ðŸ“ SHA256: $SHA256"
          
          rm vpnbypass.dmg

      - name: Update cask file
        if: steps.check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.release.outputs.latest_version }}"
          SHA256="${{ steps.sha.outputs.sha256 }}"
          
          sed -i "s/version \".*\"/version \"$VERSION\"/" Casks/vpn-bypass.rb
          sed -i "s/sha256 \".*\"/sha256 \"$SHA256\"/" Casks/vpn-bypass.rb
          
          echo "âœ… Updated cask to v$VERSION"
          cat Casks/vpn-bypass.rb

      - name: Commit and push
        if: steps.check.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/vpn-bypass.rb
          git commit -m "Update vpn-bypass to v${{ steps.release.outputs.latest_version }}"
          git push

      - name: Summary
        run: |
          echo "## Cask Update Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.needs_update }}" == "true" ]; then
            echo "âœ… Updated cask from v${{ steps.current.outputs.current_version }} to v${{ steps.release.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Cask is already up to date (v${{ steps.current.outputs.current_version }})" >> $GITHUB_STEP_SUMMARY
          fi
